\documentclass[../thesis.tex]{subfiles}

\begin{document}

\section{Abstraktsed domeenid}
\TODO{Pikem üleminek sissejuhatusest domeenide juurde}

Andmevooanalüüsiga püütakse võimalikult täpselt määrata programmi seisundit igas programmi punktis.

\begin{definition}
\emph{Domeeniks} nimetatakse programmi kõikvõimalike seisundite hulka~\cite{vojdani_magister}.
\end{definition}

Selline informaalne definitsioon on ebapiisav mingisuguse teooria arendamiseks, mistõttu tegelikult vaadetakse domeene, mis moodustavad täieliku võre.

\subsection{Võred}
\TODO{Hunnik definitsioone ehmatab ära, näide on palju lihtsamini mõistetav. Muuta järjekorda?}

Kuigi võreteooria on arvestatav matemaatika haru, siis sügavamale laskumata on siin toodud põhilised mõisted võrede mõistmiseks.
Järgnevad eestikeelsed definitsioonid on refereeritud V. Laane loengukonspektist~\cite{laan_voreteooria}, kuid tähistused on kohandatud programmianalüüsi kirjandusele omaseks~\cite[17]{seidl_foundations}:

\begin{definition}
\label{def:järjestatud_hulk}
\emph{Osaliselt järjestatud hulk} on paar $(A, \sqleq)$, kus $A$ on hulk, millel on defineeritud binaarne seos $\sqleq$, mis iga $a, b, c \in A$ korral rahuldab järgnevaid tingimusi:
\begin{itemize}[nosep]
	\item $a \sqleq a$ (refleksiivsus),
	\item kui $a \sqleq b$ ja $b \sqleq c$, siis $a \sqleq c$ (transitiivsus),
	\item kui $a \sqleq b$ ja $b \sqleq a$, siis $a = b$ (antisümmeetrilisus).
\end{itemize}
\end{definition}

Olgu $(A, \sqleq)$ osaliselt järjestatud hulk ja $X \subseteq A$.

\begin{definition}
\label{def:join}
Elementi $c$ nimetatakse hulga $X$ \emph{ülemiseks tõkkeks}, kui iga $x \in X$ korral $x \sqleq c$. Vähimat ülemist tõket nimetatakse \emph{ülemiseks rajaks}, st $X$-i iga ülemise tõkke $d$ korral $c \sqleq d$.
\end{definition}

\begin{definition}
\label{def:meet}
Elementi $c$ nimetatakse hulga $X$ \emph{alumiseks tõkkeks}, kui iga $x \in X$ korral $c \sqleq x$. Suurimat alumist tõket nimetatakse \emph{alumiseks rajaks}, st $X$-i iga alumise tõkke $d$ korral $d \sqleq c$.
\end{definition}

Hulga $X$ ülemist ja alumist raja tähistame vastavalt $\bigsqcup X$ ja $\bigsqcap X$. Kui $X = \{a, b\}$, siis tähistame ülemise ja alumise raja vastavalt $a \sqcup b$ ja $a \sqcap b$.

\begin{definition}
\emph{Täielik võre} on osaliselt järjestatud hulk, mille igal alamhulgal leidub ülemine ja alumine raja.
\end{definition}

Täielikus võres $(A, \sqleq)$ leidub vähim element $\bot = \bigsqcap A$ ja suurim element $\top = \bigsqcup A$, mida nimetatakse vastavalt \textit{bottom}iks ja \textit{top}iks.

\subsubsection{Motivatsioon}
\TODO{Jätta ära. Samad selgitused näite juures on palju selgemad.}
Kui nõuda, et domeen oleks täielik võre, siis pole ilmselge, mis rolli täidab sellel vaadeldav järjestus ja rajad.

Seisundite hulga vaatlemiseks võrena on vaja defineerida seisundite osaline järjestus. Kokkuleppeliselt järjestatakse seisundid täpsemast ebatäpsema suunas --- kirjutis $a \sqleq b$ tähendab, et seisund $a$ on vähemalt sama täpne kui seisund $b$ ning $b$ on vähemalt sama üldine kui $a$. Seega $\top$ tähistab kõige ebatäpsemat seisundit.

Sellise järjestuse korral seisundite ülemine raja kujutab endast nende seisundite ühendamist.
\TODO{\textit{join}i intuitsioon}


\subsection{Potentshulga domeen}
\TODO{\textit{powerset} = potentshulk?}

Iga hulga $S$ korral saab vaadelda selle kõigi alamhulkade hulka $\powerset{S}$, millel on loomulik osaline järjestus $\subseteq$.
Osutub, et see on ka täielik võre, kus
\begin{itemize}[nosep]
	\item $a \sqleq b \Leftrightarrow a \subseteq b$,
	\item $a \sqcup b = a \cup b$ ja $a \sqcap b = a \cap b$,
	\item $\bot = \emptyset$ ja $\top = S$.
\end{itemize}

\begin{figure}
	\centering
	\begin{subfigure}[b]{0.4\textwidth}
		\centering
		\begin{minted}{c}
		int x;
		if (rand() % 2 == 0)
			x = 5;
		else
			x = 3;
		int y = x + 1;
		\end{minted}
		\TODO{kood eraldi faili?}
		\caption{C-keelne lähtekood}
	\end{subfigure}
	~
	\begin{subfigure}[b]{0.4\textwidth}
		\centering
		\begin{tikzpicture}[
			->,>=stealth,
			node distance=0.5cm,
			every state/.style={inner sep=3pt, minimum size=0pt},
			stmt/.style={font=\ttfamily},
			initial text={},
			initial where=above
		]
			\node[initial,state] (1) {1};
			\node[state] (2) [below left=of 1] {2};
			\node[state] (3) [below right=of 1] {3};
			\node[state] (4) [below=of 2] {4};
			\node[state] (5) [below=of 3] {5};
			\node[state] (6) [below right=of 4] {6};
			\node[accepting,state] (7) [below=of 6] {7};

			\path
				(1) edge node[stmt,above left] {rand() \% 2 == 0} (2)
				    edge node[stmt,above right] {rand() \% 2 != 0} (3)
				(2) edge node[stmt,left] {x = 5} (4)
				(3) edge node[stmt,right] {x = 3} (5)
				(4) edge node {} (6)
				(5) edge node {} (6)
				(6) edge node[stmt,right] {y = x + 1} (7);
		\end{tikzpicture}
		\TODO{programmi laused tippudes või servades?}
		\TODO{tikz eraldi .tex faili?}
		\caption{Juhtimisvoograaf}
	\end{subfigure}

	\caption{Tsüklita programmi näidis.}
	\label{lst:if}
\end{figure}

Hulk $X$ kirjeldab väärtust $z$ parajasti siis, kui $z \in X$. Sellega on defineeritud, kuidas peaks seostama domeeni elemente konkreetsete võimalike väärtustega.

Olgu vaatluse all programm jooniselt~\ref{lst:if}, kus on kõrvuti C-keelse lähtekoodi jupp ja selle juhtimisvoograaf, mille tippudes on programmi punktid, kus seisundeid vaadeldakse, ja servadel vastavad laused, mida täidetakse. Muutuja \texttt{x} võimalikke väärtusi ehk selle seisundeid saab analüüsida domeenis $(\powerset{\mathbb{Z}}, \subseteq)$:
\begin{itemize}
	\item Punktides 1, 2 ja 3 on muutuja veel väärtustamata. Kuna C keele semantika sellisel juhul mingit vaikeväärtust ei anna, siis võimalikke väärtusi kirjeldab kõige ebatäpsem domeeni element $\top = \mathbb{Z}$.
	\item Punktis 4 on muutujale just antud konstantne väärtus, mistõttu seda kirjeldab kõige paremini element $\{5\}$.

		Iseenesest poleks vale seostada selle programmi punktiga mõnda (osalise järjestuse järgi) üldisemat seisundit, nt $\{5, 6, 7\}$ või lausa $\top$, kuid see poleks nii kasulik, sest analüüsi mõte on siiski leida võimalikult täpne kirjeldus. Just selle täpsuse matemaatiliseks kirjeldamiseks nõutaksegi osalist järjestust.
	\item Punktiga 5 sobib samal põhjusel seostada element $\{3\}$.
	\item Punktis 6 on olukord huvitavam, sest seda seisundit pole programmis oleva hargnemise (täpsemalt selle ühendumise) tõttu kirjeldada ühe täisarvuga, vaid elemendiga $\{3, 5\}$. Selle tulemuseni jõudmiseks peab intuitiivselt ühendama eelneva kahe punkti seisundid --- leidma seisundi, mis hõlmaks eelnevaid, olles seejuures võimalikult täpne. Just selleks nõutaksegi ülemise raja leidmise tehet, millega seda teha. Antud juhul $\{3\} \sqcup \{5\} = \{3, 5\}$.
\end{itemize}

Näitest peaks olema selge, miks üldse nõuda, et domeen oleks võre, ja millised võimalused see annab domeeni kasutamiseks programmide analüüsimisel. Kirjeldatud näide analüüsis ainult muutujat \texttt{x} ja jättis täielikult kõrvale muutuja \texttt{y}. Loomulikult võiks analüüs midagi öelda ka selle kohta.

\TODO{Näide tervest analüüsist: +üleminekufunktsioonid +võrratuste süsteem +süsteemi lahendamine. Sama näite peal?}

\subsection{Kujutusdomeen}
\TODO{\textit{mapdomain} --- funktsioondomeen? kujutusdomeen?}
Olgu $\Var$ programmi muutujate hulk ja $\Val$ domeen, milles vaadeldakse ühe muutuja seisundit. Sel juhul saab vaadelda abstraktsete muutujate väärtustuste domeeni~\cite[45]{seidl_foundations}
\[
	\mathbb{D} = (\Var \to \Val)_\bot = (\Var \to \Val) \cup \{\bot\}.
\]
Domeeni elementideks on kujutused muutujate hulgast abstraktsete väärtuste hulka, mis on väga analoogilised konkreetsete muutujate väärtustustega funktsionaalselt kirjeldatuna. Element $\bot$ on tehislikult lisatud, et domeen moodustaks täieliku võre, ja tähendab hetkel teadaolevalt saavutamatut programmi punkti. Osaline järjestus selles domeenis on defineeritud järgnevaga:
\[
	D_1 \sqleq D_2 \quad\Longleftrightarrow\quad D_1 = \bot \quad\lor\quad \forall x \in \Var\; D_1(x) \sqleq D_2(x).
\]
\TODO{Tehted kujutustel, $\top$?}

Eelnevas näites $\Var = \{\texttt{x}, \texttt{y}\}$ ja jätkamiseks sobib juba nähtud $\Val = \powerset{\mathbb{Z}}$. Analüüsides programmi jooniselt~\ref{lst:if} nüüd selles domeenis, saame seisundid:
\begin{itemize}
	\item Punktides 1, 2 ja 3: $\{ \texttt{x} \mapsto \top, \texttt{y} \mapsto \top \}$.
	\item Punktis 4: $\{ \texttt{x} \mapsto \{5\}, \texttt{y} \mapsto \top \}$.
	\item Punktis 5: $\{ \texttt{x} \mapsto \{3\}, \texttt{y} \mapsto \top \}$.
	\item Punktis 6: $\{ \texttt{x} \mapsto \{3, 5\}, \texttt{y} \mapsto \top \}$.
	\item Punktis 7: $\{ \texttt{x} \mapsto \{3, 5\}, \texttt{y} \mapsto \{4, 6\} \}$, sest muutuja \texttt{y} on avaldatud \texttt{x}-i kaudu, mis on juba analüüsitud.
	\TODO{Abstraktne liitmistehe}
\end{itemize}

Siit selgubki, et väikese vaevaga on võimalik lihtsam ühte muutujat korraga kirjeldav domeen laiendada kõigile muutujatele korraga. Seejuures muutub võimalikuks järgida andmete liikumist muutujate vahel, mis vastab juba paremini andmevooanalüüsi nimele.

Sellegipoolest pole vaadeldu praktiliselt teostatav, sest võimalike väärtuste hulk võib olla lõpmatu ja seejuures ka ebatriviaalne. Üldiselt pole võimalik selliseid hulki programmis kirjeldada ja nendega opereerida. Seetõttu loobutakse ülimast täpsusest suvaliste hulkade kujul ja kasutatakse ebatäpsemaid domeene väärtuste kirjeldamiseks, mida on võimalik analüsaatorisse implementeerida. Üheks variandiks on vaadelda väärtuste lõike.

\subsection{Intervalldomeen}
Intervalldomeen on domeen, milles täisarvude väärtuste abstraheerimiseks kasutatakse arvtelje lõike.

\begin{definition}
\emph{Intervalldomeeniks}~\cite[55]{seidl_foundations} nimetatakse hulka
\[
	\mathbb{I} = \{ [l, u] \mid l \in \mathbb{Z} \cup \{-\infty\}, u \in \mathbb{Z} \cup \{+\infty\}, l \leq u \},
\]
millel on osaline järjestus
\[
	[l_1, u_1] \sqleq [l_2, u_2] \quad\Longleftrightarrow\quad l_2 \leq l_1 \land u_1 \leq u_2.
\]
\end{definition}

Sellises domeenis
\begin{align*}
	[l_1, u_1] \sqcup [l_2, u_2] &= [\min\{l_1, l_2\}, \max\{u_1, u_2\}], \\
	[l_1, u_1] \sqcap [l_2, u_2] &= [\max\{l_1, l_2\}, \min\{u_1, u_2\}],\quad \text{kui } \max\{l_1, l_2\} \leq \min\{u_1, u_2\}.
\end{align*}
\TODO{Joonis intervallide $\sqcup, \sqcap$ kohta \textit{a la} Seidl}
Kuna alumine raja on ainult tinglikult defineeritud, siis see pole täielik võre. See pole probleem, kuna pisut täiendatud domeen $\mathbb{I}_\bot = \mathbb{I} \cup \{\bot\}$ osutub täielikuks võreks.
Lõigu otspunktides on lubatud vastavad lõpmatust kirjeldavad väärtused, mis võimaldavad rääkida selles domeenis suurimast elemendist $\top = [-\infty, +\infty]$.

Lõik $[l, u]$ kirjeldab täisarvu $z$ parajasti siis, kui $l \leq z \leq u$.

Valides eelnevas joonisel~\ref{lst:if} tehtud näites $\Var = \mathbb{I}$, saame seisundid analoogiliselt:
\begin{itemize}
	\item Punktides 1, 2 ja 3: $\{ \texttt{x} \mapsto \top, \texttt{y} \mapsto \top \}$.
	\item Punktis 4: $\{ \texttt{x} \mapsto [5, 5], \texttt{y} \mapsto \top \}$.
	\item Punktis 5: $\{ \texttt{x} \mapsto [3, 3], \texttt{y} \mapsto \top \}$.
	\item Punktis 6: $\{ \texttt{x} \mapsto [3, 5], \texttt{y} \mapsto \top \}$, kus \texttt{x}-i seisundi saab avaldada harudes olevatest: $[3, 3] \sqcup [5, 5] = [3, 5]$.
	\item Punktis 7: $\{ \texttt{x} \mapsto [3, 5], \texttt{y} \mapsto [4, 6] \}$.
\end{itemize}


\end{document}